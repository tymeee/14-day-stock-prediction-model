# -*- coding: utf-8 -*-
"""streamlit_app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1THAzBA7SGpVN_VRcZ2-7OIYeuOaEObg-
"""

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import joblib
from fastai.tabular.all import load_learner
import ta

# --- Define indicator functions ---
def compute_volatility_indicators(df):
    if len(df) < 14:
        for col in ['atr', 'bb_bbm', 'donchianwidth', 'keltnerwidth',
                    'ulcer', 'chaikin_volatility', 'historical_volatility',
                    'upper_band', 'lower_band']:
            df[col] = float('nan')
        return df

    atr = ta.volatility.AverageTrueRange(df['High'], df['Low'], df['Close'], window=14)
    df['atr'] = atr.average_true_range()

    bb = ta.volatility.BollingerBands(df['Close'], window=14)
    df['bb_bbm'] = bb.bollinger_mavg()

    dc = ta.volatility.DonchianChannel(df['High'], df['Low'], df['Close'], window=14)
    df['donchianwidth'] = dc.donchian_channel_wband()

    kc = ta.volatility.KeltnerChannel(df['High'], df['Low'], df['Close'], window=14)
    df['keltnerwidth'] = kc.keltner_channel_wband()

    ui = ta.volatility.UlcerIndex(df['Close'], window=14)
    df['ulcer'] = ui.ulcer_index()

    hl_range = df['High'] - df['Low']
    ema_hl = hl_range.ewm(span=10, adjust=False).mean()
    df['chaikin_volatility'] = ((ema_hl - ema_hl.shift(10)) / ema_hl.shift(10)) * 100

    log_return = np.log(df['Close'] / df['Close'].shift(1))
    df['historical_volatility'] = log_return.rolling(window=20).std() * np.sqrt(252)

    df['upper_band'] = df['High'].rolling(window=2).max()
    df['lower_band'] = df['Low'].rolling(window=2).min()

    return df

def compute_trend_indicators(df):
    if len(df) < 14:
        for col in ['macd', 'sma', 'ema', 'adx', 'psar-up', 'psar-down',
                    'ichimoku_a', 'ichimoku_b', 'supertrend', 'KST',
                    'plus_di', 'minus_di', 'VI-dff', 'VI+', 'VI-']:
            df[col] = float('nan')
        return df

    df['macd'] = ta.trend.MACD(df['Close']).macd()
    df['sma'] = ta.trend.SMAIndicator(df['Close'], window=14).sma_indicator()
    df['ema'] = ta.trend.EMAIndicator(df['Close'], window=14).ema_indicator()
    df['adx'] = ta.trend.ADXIndicator(df['High'], df['Low'], df['Close'], window=14).adx()
    df['psar-up'] = ta.trend.psar_up(df['High'], df['Low'], df['Close'])
    df['psar-down'] = ta.trend.psar_down(df['High'], df['Low'], df['Close'])
    ichi = ta.trend.IchimokuIndicator(df['High'], df['Low'])
    df['ichimoku_a'] = ichi.ichimoku_a()
    df['ichimoku_b'] = ichi.ichimoku_b()
    df['supertrend'] = ta.trend.stc(df['Close'])
    df['KST'] = ta.trend.KSTIndicator(df['Close']).kst()
    df['plus_di'] = ta.trend.adx_pos(df['High'], df['Low'], df['Close'])
    df['minus_di'] = ta.trend.adx_neg(df['High'], df['Low'], df['Close'])
    vortex = ta.trend.VortexIndicator(df['High'], df['Low'], df['Close'])
    df['VI-dff'] = vortex.vortex_indicator_diff()
    df['VI+'] = vortex.vortex_indicator_pos()
    df['VI-'] = vortex.vortex_indicator_neg()

    return df

def compute_momentum_indicators(df):
    df['rsi'] = ta.momentum.RSIIndicator(df['Close']).rsi()
    df['stochastic'] = ta.momentum.StochasticOscillator(df['High'], df['Low'], df['Close']).stoch()
    df['signal-stochastic'] = ta.momentum.StochasticOscillator(df['High'], df['Low'], df['Close']).stoch_signal()
    df['cci'] = ta.trend.CCIIndicator(df['High'], df['Low'], df['Close']).cci()
    df['williams%R'] = ta.momentum.WilliamsRIndicator(df['High'], df['Low'], df['Close']).williams_r()
    df['roc'] = ta.momentum.ROCIndicator(df['Close']).roc()
    df['awesome-oscillator'] = ta.momentum.AwesomeOscillatorIndicator(df['High'], df['Low']).awesome_oscillator()
    df['ultimate-oscillator'] = ta.momentum.UltimateOscillator(df['High'], df['Low'], df['Close']).ultimate_oscillator()
    df['trix'] = ta.trend.TRIXIndicator(df['Close']).trix()
    df['KAMA'] = ta.momentum.KAMAIndicator(df['Close'], window=10).kama()
    df['stochrsi'] = ta.momentum.StochRSIIndicator(df['Close']).stochrsi()
    return df

def add_technical_indicators(df):
    df = compute_volatility_indicators(df)
    df = compute_trend_indicators(df)
    df = compute_momentum_indicators(df)
    return df

# --- Load models ---
xgb_model = joblib.load('xgb_best_model_randomsearch.joblib')
lstm_model = load_learner('lstm_learner.pkl')

# --- Streamlit UI ---
st.title("📈 14-Day Stock Return Predictor")
st.markdown("Enter a stock ticker (e.g., AAPL, MSFT) to get predictions based on recent technical indicators.")

ticker = st.text_input("Stock Ticker", value="AAPL")

if st.button("Fetch & Predict"):
    try:
        df = yf.download(ticker, period="60d", interval="1d")
        if df.empty or len(df) < 30:
            st.warning("Not enough data. Try another ticker.")
        else:
            df = df.rename(columns={"Open": "Open", "High": "High", "Low": "Low", "Close": "Close", "Volume": "Volume"})
            df = add_technical_indicators(df)
            df = df.dropna()

            latest = df.iloc[-1:].copy()
            x_features = latest.drop(columns=["Open", "High", "Low", "Close", "Volume"], errors='ignore')

            xgb_pred = xgb_model.predict(x_features)[0]
            lstm_pred_raw = lstm_model.predict(latest)[0]
            lstm_pred = float(lstm_pred_raw)

            st.success("✅ Predictions")
            st.write(f"📊 **XGBoost**: `{xgb_pred:.4f}` % return in 14 days")
            st.write(f"📈 **LSTM**: `{lstm_pred:.4f}` % return in 14 days")

    except Exception as e:
        st.error(f"❌ Error: {e}")